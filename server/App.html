<!DOCTYPE html><html lang="en"><head><title>server/App</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="server/App"><meta name="groc-project-path" content="server/App.ls"><meta name="groc-github-url" content="https://github.com/DimensionSoftware/instant-skeleton"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/DimensionSoftware/instant-skeleton/blob/master/server/App.ls">server/App.ls</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-built_in">global</span> &lt;&lt;&lt; <span class="hljs-built_in">require</span> <span class="hljs-string">\prelude-ls</span> <span class="hljs-comment"># immutable (ease-of-access)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>App</p></div></div><div class="code"><div class="wrapper"><span class="hljs-comment">#####</span>
<span class="hljs-built_in">require</span>! {
  fs
  http
  <span class="hljs-string">'pretty-error'</span>: PrettyError

  koa
  <span class="hljs-string">\koa-level</span>
  <span class="hljs-string">\koa-logger</span>
  <span class="hljs-string">'koa-helmet'</span>: helmet

  <span class="hljs-string">'level-sublevel'</span>
  <span class="hljs-string">'level-party'</span>: level

  <span class="hljs-string">'koa-generic-session'</span>: koa-session

  <span class="hljs-attribute">primus</span>: Primus
  <span class="hljs-string">\primus-emitter</span>
  <span class="hljs-string">\primus-multiplex</span>

  <span class="hljs-string">\./pages</span>
  <span class="hljs-string">\./services</span>
  <span class="hljs-string">\./middleware</span>

  <span class="hljs-string">\../shared/features</span>
}

pe   = <span class="hljs-keyword">new</span> PrettyError!
env  = process.env.NODE_ENV <span class="hljs-keyword">or</span> <span class="hljs-string">\development</span>
prod = env <span class="hljs-keyword">is</span> <span class="hljs-string">\production</span>

db      = level-sublevel(level <span class="hljs-string">'./shared/db'</span> {<span class="hljs-attribute">encoding</span>:<span class="hljs-string">\json})</span>
sdb     = db.sublevel <span class="hljs-string">\session</span>
store   = koa-level {<span class="hljs-attribute">db</span>:sdb}
session = koa-session {store}

<span class="hljs-comment">### App's purpose is to abstract instantiation from starting &amp; stopping</span>
<span class="hljs-built_in">module</span>.exports =
  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span></span>
    <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@port</span>=<span class="hljs-string">\ephemeral,</span> <span class="hljs-property">@changeset</span>=<span class="hljs-string">\latest)</span> -&gt;

    start: (cb = (-&gt;)) -&gt;
      <span class="hljs-built_in">console</span>.log <span class="hljs-string">"[1;37;30m+ [1;37;40m<span class="hljs-subst">#env</span>[0;m @ port [1;37;40m<span class="hljs-subst">#{<span class="hljs-property">@port</span>}</span>[0;m #<span class="hljs-subst">#{<span class="hljs-property">@changeset</span>[<span class="hljs-keyword">to</span> <span class="hljs-number">5</span>].join <span class="hljs-string">''</span>}</span>"</span>

      <span class="hljs-property">@app</span> = koa! # attach middlewares
        ..keys = [<span class="hljs-string">'iAsNHei275_#@$#%^&amp;'</span>]   # cookie session secrets
        ..<span class="hljs-literal">on</span> <span class="hljs-string">\error</span> (err) -&gt;
          <span class="hljs-built_in">console</span>.error(pe.render err)    # error handler
        ..use helmet.defaults!            # solid secure base
        ..use middleware.webpack
        ..use middleware.error-handler    # <span class="hljs-number">404</span> &amp; <span class="hljs-number">50x</span> handler
        ..use middleware.config-locals @  # load env-sensitive config into locals
        ..use middleware.rate-limit       # rate limiting <span class="hljs-keyword">for</span> all requests (override <span class="hljs-keyword">in</span> package.json config)
        ..use middleware.static-assets    # static assets handler
        ..use middleware.app-cache        # offline support
        ..use session                     # leveldb session support
        ..use middleware.jade             # use minimalistic jade layout (escape-hatch <span class="hljs-keyword">from</span> react)
        ..use middleware.etags            # auto etag every page <span class="hljs-keyword">for</span> caching
        ..use pages                       # apply pages
        ..use services.router             # apply realtime services
</span></span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>config environment</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">if</span> env <span class="hljs-keyword">isnt</span> <span class="hljs-string">\test</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@app</span>.use koa-logger!</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>boot http &amp; websocket servers</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-property">@server</span> = http.create-server <span class="hljs-property">@app</span>.callback!
      <span class="hljs-property">@primus</span> = <span class="hljs-keyword">new</span> Primus <span class="hljs-property">@server</span>, <span class="hljs-attribute">transformer</span>: <span class="hljs-string">\engine.io,</span> <span class="hljs-attribute">parser</span>: <span class="hljs-string">\JSON</span>
        ..before (middleware.primus-koa-session store, <span class="hljs-property">@app</span>.keys)
        ..use <span class="hljs-string">\multiplex</span> primus-multiplex
        ..use <span class="hljs-string">\emitter</span> primus-emitter
        ..remove <span class="hljs-string">\primus.js</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>init realtime services</p></div></div><div class="code"><div class="wrapper">      services.init sdb, <span class="hljs-property">@primus</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>listen</p></div></div><div class="code"><div class="wrapper">      <span class="hljs-keyword">unless</span> <span class="hljs-property">@port</span> <span class="hljs-keyword">is</span> <span class="hljs-string">\ephemeral</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@server</span>.listen <span class="hljs-property">@port</span>, cb
      <span class="hljs-property">@app</span>

    <span class="hljs-attribute">stop</span>: <span class="hljs-function"><span class="hljs-params">(cb = (-&gt;))</span> -&gt;</span>
      <span class="hljs-built_in">console</span>.log <span class="hljs-string">"[1;37;30m- [1;37;40m<span class="hljs-subst">#env</span>[0;m @ port [1;37;40m<span class="hljs-subst">#{<span class="hljs-property">@port</span>}</span>[0;m #<span class="hljs-subst">#{<span class="hljs-property">@changeset</span>[<span class="hljs-keyword">to</span> <span class="hljs-number">5</span>].join <span class="hljs-string">''</span>}</span>"</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>cleanup &amp; quit listening</p></div></div><div class="code"><div class="wrapper">      &lt;~ <span class="hljs-property">@primus</span>.destroy
      &lt;~ <span class="hljs-property">@server</span>.close
      db.close cb</div></div></div></div></body></html>