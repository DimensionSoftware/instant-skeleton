'use strict';

var ipchecker = module.exports = {};

ipchecker.create = function (allow) {
  var map = ipchecker.map(allow);
  return function (ip) {
    return ipchecker.check(ip, map);
  };
};

ipchecker.check = function (ip, map) {
  map || (map = {});

  var nums = ip.split('.');
  var obj = map;
  var num;

  while (num = nums.shift()) {
    if (obj['*']) {
      num = '*';
    } else {
      if (obj[num] === undefined) {
        return false;
      }
    }
    obj = obj[num];
  }

  return true;
};

ipchecker.map = function (list) {
  var map = {};

  list || (list = []);
  Array.isArray(list) || (list = [list]);

  list.forEach(function (ip) {
    var nums = ip.split('.');
    var len = nums.length;
    var obj = map;
    var i;

    for (i = 0; i < len; i += 1) {
      var num = nums[i];
      var val;

      if (num === '*') {
        obj['*'] = {};
      } else if (!obj[num]) {
        obj[num] = i + 1 === len ? 1 : {};
      }

      obj = obj[num];
    }
  });

  return map;
};
