#!/bin/bash

if [ "$NODE_ENV" = 'production' ]; then
  date
  # compile server app
  # TODO use webpack
  echo -n 'Compiling app server '
  for f in `find . -name \*.ls -print`
  do
    node_modules/.bin/lsc -c -o build/`dirname $f` $f
    echo -n '.'
  done
  echo '| done.'

  # compile client app & css
  echo 'Building client bundle ...'
  webpack

  # run using pm2!
  echo "Booting new app!"
  pm2 start processes.json

else
  # defer to gulp
  node --harmony `which gulp`
fi
