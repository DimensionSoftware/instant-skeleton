#!/bin/bash

# export .env before booting node
eval `sed 's/^/export /' .env`
if [ -z "$NODE_ENV" ]; then
  echo 'Please export a proper NODE_ENV as .env or otherwise'
  exit 1
fi

if [ "$NODE_ENV" = 'production' ]; then
  # build server & client with gulp
  echo -n 'Building app @ '
  date
  node --harmony `which gulp`

  # run using pm2!
  echo -n 'Booting new app @ '
  date
  pm2 start ecosystem.json

else
  pid='app.pid'
  # log pid if detached & defer to gulp
  node --harmony `which gulp`
  echo $! > "$pid"
fi
